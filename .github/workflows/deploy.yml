name: "Deploy Quarto Site"

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: "ubuntu-latest"
    
    permissions:
      contents: write
    
    steps:
      # 1. Checkout
      - uses: "actions/checkout@v4"
      
      # 2. Install Quarto
      - name: "Install Quarto"
        run: |
          wget -q https://github.com/quarto-dev/quarto-cli/releases/download/v1.4.553/quarto-1.4.553-linux-amd64.deb
          sudo dpkg -i quarto-1.4.553-linux-amd64.deb
      
      # 3. Install Python dependencies (si nÃ©cessaire pour vos notebooks)
      - name: "Install Python packages"
        run: pip install numpy pandas matplotlib scikit-learn ipywidgets
      
      # 4. Optionnel : VÃ©rifier la structure du projet
      - name: "List project structure"
        run: |
          echo "ðŸ“ Structure du projet :"
          ls -la
          echo ""
          echo "ðŸ“ Fichiers Quarto :"
          find . -name "*.qmd" -o -name "_quarto.yml" -o -name "_quarto.yaml" | head -20
      
      # 5. Build Quarto site
      - name: "Build Quarto site"
        run: |
          # CrÃ©er le fichier de configuration Quarto s'il n'existe pas
          if [ ! -f "_quarto.yml" ] && [ ! -f "_quarto.yaml" ]; then
            echo "CrÃ©ation d'une configuration Quarto basique..."
            cat > _quarto.yml << 'EOF'
project:
  type: website
  output-dir: _site
  
website:
  title: "Cours IA/ML - nevermind78"
  navbar:
    background: "primary"
    search: true
  page-navigation: true

format:
  html:
    theme: cosmo
    toc: true
    css: styles.css
EOF
          fi
          
          # Rendre le site
          quarto render
          
          # VÃ©rifier le contenu gÃ©nÃ©rÃ©
          echo "ðŸ“ Contenu gÃ©nÃ©rÃ© dans _site/:"
          ls -la _site/
      
      # 6. DÃ©ployer avec l'action qui fonctionne
      - name: "Deploy"
        uses: "peaceiris/actions-gh-pages@v3"
        with:
          github_token: "${{ secrets.GITHUB_TOKEN }}"
          publish_dir: "./_site"
          force_orphan: true  # Cette option crÃ©e la branche si elle n'existe pas
          keep_files: false